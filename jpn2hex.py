# jpn2hex -- reencodes SD2 Japanese characters in an Atlas command file
d = {
	"7F": '*', # newline marker
	"80": "、",
	"81": "。",
	"82": "！",
	"83": "？",
	"84": "ー",
	"85": "‥",
	"86": "「",
	"87": "」",
	"88": "『",
	"89": "』",
	"8A": "あ",
	"8B": "い",
	"8C": "う",
	"8D": "え",
	"8E": "お",
	"8F": "か",
	"90": "き",
	"91": "く",
	"92": "け",
	"93": "こ",
	"94": "さ",
	"95": "し",
	"96": "す",
	"97": "せ",
	"98": "そ",
	"99": "た",
	"9A": "ち",
	"9B": "つ",
	"9C": "て",
	"9D": "と",
	"9E": "な",
	"9F": "に",
	"A0": "ぬ",
	"A1": "ね",
	"A2": "の",
	"A3": "は",
	"A4": "ひ",
	"A5": "ふ",
	"A6": "へ",
	"A7": "ほ",
	"A8": "ま",
	"A9": "み",
	"AA": "む",
	"AB": "め",
	"AC": "も",
	"AD": "や",
	"AE": "ゆ",
	"AF": "よ",
	"B0": "ら",
	"B1": "り",
	"B2": "る",
	"B3": "れ",
	"B4": "ろ",
	"B5": "わ",
	"B6": "ん",
	"B7": "を",
	"B8": "っ",
	"B9": "ゃ",
	"BA": "ゅ",
	"BB": "ょ",
	"BC": "ぁ",
	"BD": "ぃ",
	"BE": "ぅ",
	"BF": "ぇ",
	"C0": "ぉ",
	"C1": "が",
	"C2": "ぎ",
	"C3": "ぐ",
	"C4": "げ",
	"C5": "ご",
	"C6": "ざ",
	"C7": "じ",
	"C8": "ず",
	"C9": "ぜ",
	"CA": "ぞ",
	"CB": "だ",
	"CC": "ぢ",
	"CD": "づ",
	"CE": "で",
	"CF": "ど",
	"D0": "ば",
	"D1": "び",
	"D2": "ぶ",
	"D3": "べ",
	"D4": "ぼ",
	"D5": "ぱ",
	"D6": "ぴ",
	"D7": "ぷ",
	"D8": "ぺ",
	"D9": "ぽ",
	"DA": "Ａ",
	"DB": "Ｂ",
	"DC": "Ｃ",
	"DD": "Ｄ",
	"DE": "Ｅ",
	"DF": "Ｆ",
	"E0": "Ｇ",
	"E1": "Ｈ",
	"E2": "Ｉ",
	"E3": "Ｊ",
	"E4": "Ｋ",
	"E5": "Ｌ",
	"E6": "Ｍ",
	"E7": "Ｎ",
	"E8": "Ｏ",
	"E9": "Ｐ",
	"EA": "Ｑ",
	"EB": "Ｒ",
	"EC": "Ｓ",
	"ED": "Ｔ",
	"EE": "Ｕ",
	"EF": "Ｖ",
	"F0": "Ｗ",
	"F1": "Ｘ",
	"F2": "Ｙ",
	"F3": "Ｚ",
	"F4": "・",
	"F5": "：",
	"F6": "；",
	"F7": "～",
	"F8": "／",
	"F9": "（",
	"FA": "）",
	"FB": "聖",
	"FC": "剣",
	"FD": "伝",
	"FE": "説",
	"FF": "　"
}
d = {v: k for k, v in d.items()}

s1 = {
	"00": "、",
	"01": "。",
	"02": "！",
	"03": "？",
	"04": "ー",
	"05": "‥",
	"06": "」",
	"07": "「",
	"08": "『",
	"09": "』",
	"0A": "あ",
	"0B": "い",
	"0C": "う",
	"0D": "え",
	"0E": "お",
	"0F": "か",
	"10": "き",
	"11": "く",
	"12": "け",
	"13": "こ",
	"14": "さ",
	"15": "し",
	"16": "す",
	"17": "せ",
	"18": "そ",
	"19": "た",
	"1A": "ち",
	"1B": "つ",
	"1C": "て",
	"1D": "と",
	"1E": "な",
	"1F": "に",
	"20": "ぬ",
	"21": "ね",
	"22": "の",
	"23": "は",
	"24": "ひ",
	"25": "ふ",
	"26": "へ",
	"27": "ほ",
	"28": "ま",
	"29": "み",
	"2A": "む",
	"2B": "め",
	"2C": "も",
	"2D": "や",
	"2E": "ゆ",
	"2F": "よ",
	"30": "ら",
	"31": "り",
	"32": "る",
	"33": "れ",
	"34": "ろ",
	"35": "わ",
	"36": "ん",
	"37": "を",
	"38": "っ",
	"39": "ゃ",
	"3A": "ゅ",
	"3B": "ょ",
	"3C": "ぁ",
	"3D": "ぃ",
	"3E": "ぅ",
	"3F": "ぇ",
	"40": "ぉ",
	"41": "が",
	"42": "ぎ",
	"43": "ぐ",
	"44": "げ",
	"45": "ご",
	"46": "ざ",
	"47": "じ",
	"48": "ず",
	"49": "ぜ",
	"4A": "ぞ",
	"4B": "だ",
	"4C": "ぢ",
	"4D": "づ",
	"4E": "で",
	"4F": "ど",
	"50": "ば",
	"51": "び",
	"52": "ぶ",
	"53": "べ",
	"54": "ぼ",
	"55": "ぱ",
	"56": "ぴ",
	"57": "ぷ",
	"58": "ぺ",
	"59": "ぽ",
	"5A": "Ａ",
	"5B": "Ｂ",
	"5C": "Ｃ",
	"5D": "Ｄ",
	"5E": "Ｅ",
	"5F": "Ｆ",
	"60": "Ｇ",
	"61": "Ｈ",
	"62": "Ｉ",
	"63": "Ｊ",
	"64": "Ｋ",
	"65": "Ｌ",
	"66": "Ｍ",
	"67": "Ｎ",
	"68": "Ｏ",
	"69": "Ｐ",
	"6A": "Ｑ",
	"6B": "Ｒ",
	"6C": "Ｓ",
	"6D": "Ｔ",
	"6E": "Ｕ",
	"6F": "Ｖ",
	"70": "Ｗ",
	"71": "Ｘ",
	"72": "Ｙ",
	"73": "Ｚ",
	"74": "・",
	"75": "：",
	"76": "；",
	"77": "～",
	"78": "／",
	"79": "（",
	"7A": "）",
	"7B": "聖",
	"7C": "剣",
	"7D": "伝",
	"7E": "説",
	"7F": "　",
	"80": "０",
	"81": "１",
	"82": "２",
	"83": "３",
	"84": "４",
	"85": "５",
	"86": "６",
	"87": "７",
	"88": "８",
	"89": "９",
	"8A": "ア",
	"8B": "イ",
	"8C": "ウ",
	"8D": "エ",
	"8E": "オ",
	"8F": "カ",
	"90": "キ",
	"91": "ク",
	"92": "ケ",
	"93": "コ",
	"94": "サ",
	"95": "シ",
	"96": "ス",
	"97": "セ",
	"98": "ソ",
	"99": "タ",
	"9A": "チ",
	"9B": "ツ",
	"9C": "テ",
	"9D": "ト",
	"9E": "ナ",
	"9F": "ニ",
	"A0": "ヌ",
	"A1": "ネ",
	"A2": "ノ",
	"A3": "ハ",
	"A4": "ヒ",
	"A5": "フ",
	"A6": "ヘ",
	"A7": "ホ",
	"A8": "マ",
	"A9": "ミ",
	"AA": "ム",
	"AB": "メ",
	"AC": "モ",
	"AD": "ヤ",
	"AE": "ユ",
	"AF": "ヨ",
	"B0": "ラ",
	"B1": "リ",
	"B2": "ル",
	"B3": "レ",
	"B4": "ロ",
	"B5": "ワ",
	"B6": "ン",
	"B7": "ヲ",
	"B8": "ッ",
	"B9": "ャ",
	"BA": "ュ",
	"BB": "ョ",
	"BC": "ァ",
	"BD": "ィ",
	"BE": "ゥ",
	"BF": "ェ",
	"C0": "ォ",
	"C1": "ガ",
	"C2": "ギ",
	"C3": "グ",
	"C4": "ゲ",
	"C5": "ゴ",
	"C6": "ザ",
	"C7": "ジ",
	"C8": "ズ",
	"C9": "ゼ",
	"CA": "ゾ",
	"CB": "ダ",
	"CC": "ヂ",
	"CD": "ヅ",
	"CE": "デ",
	"CF": "ド",
	"D0": "バ",
	"D1": "ビ",
	"D2": "ブ",
	"D3": "ベ",
	"D4": "ボ",
	"D5": "パ",
	"D6": "ピ",
	"D7": "プ",
	"D8": "ペ",
	"D9": "ポ",
	"DA": "ａ",
	"DB": "ｂ",
	"DC": "ｃ",
	"DD": "ｄ",
	"DE": "ｅ",
	"DF": "ｆ",
	"E0": "ｇ",
	"E1": "ｈ",
	"E2": "ｉ",
	"E3": "ｊ",
	"E4": "ｋ",
	"E5": "ｌ",
	"E6": "ｍ",
	"E7": "ｎ",
	"E8": "ｏ",
	"E9": "ｐ",
	"EA": "ｑ",
	"EB": "ｒ",
	"EC": "ｓ",
	"ED": "ｔ",
	"EE": "ｕ",
	"EF": "ｖ",
	"F0": "ｗ",
	"F1": "ｘ",
	"F2": "ｙ",
	"F3": "ｚ",
	"F4": "ヴ",
	"F5": "々",
	"F6": "落",
	"F7": "悪",
	"F8": "入",
	"F9": "手",
	"FA": "用",
	"FB": "先",
	"FC": "安",
	"FD": "誰",
	"FE": "音",
	"FF": "▽"
}
s1 = {v: k for k, v in s1.items()}

s2 = {
	"00":"０",
	"01":"１",
	"02":"２",
	"03":"３",
	"04":"４",
	"05":"５",
	"06":"６",
	"07":"７",
	"08":"８",
	"09":"９",
	"0A":"ア",
	"0B":"イ",
	"0C":"ウ",
	"0D":"エ",
	"0E":"オ",
	"0F":"カ",
	"10":"キ",
	"11":"ク",
	"12":"ケ",
	"13":"コ",
	"14":"サ",
	"15":"シ",
	"16":"ス",
	"17":"セ",
	"18":"ソ",
	"19":"タ",
	"1A":"チ",
	"1B":"ツ",
	"1C":"テ",
	"1D":"ト",
	"1E":"ナ",
	"1F":"ニ",
	"20":"ヌ",
	"21":"ネ",
	"22":"ノ",
	"23":"ハ",
	"24":"ヒ",
	"25":"フ",
	"26":"ヘ",
	"27":"ホ",
	"28":"マ",
	"29":"ミ",
	"2A":"ム",
	"2B":"メ",
	"2C":"モ",
	"2D":"ヤ",
	"2E":"ユ",
	"2F":"ヨ",
	"30":"ラ",
	"31":"リ",
	"32":"ル",
	"33":"レ",
	"34":"ロ",
	"35":"ワ",
	"36":"ン",
	"37":"ヲ",
	"38":"ッ",
	"39":"ャ",
	"3A":"ュ",
	"3B":"ョ",
	"3C":"ァ",
	"3D":"ィ",
	"3E":"ゥ",
	"3F":"ェ",
	"40":"ォ",
	"41":"ガ",
	"42":"ギ",
	"43":"グ",
	"44":"ゲ",
	"45":"ゴ",
	"46":"ザ",
	"47":"ジ",
	"48":"ズ",
	"49":"ゼ",
	"4A":"ゾ",
	"4B":"ダ",
	"4C":"ヂ",
	"4D":"ヅ",
	"4E":"デ",
	"4F":"ド",
	"50":"バ",
	"51":"ビ",
	"52":"ブ",
	"53":"ベ",
	"54":"ボ",
	"55":"パ",
	"56":"ピ",
	"57":"プ",
	"58":"ペ",
	"59":"ポ",
	"5A":"ａ",
	"5B":"ｂ",
	"5C":"ｃ",
	"5D":"ｄ",
	"5E":"ｅ",
	"5F":"ｆ",
	"60":"ｇ",
	"61":"ｈ",
	"62":"ｉ",
	"63":"ｊ",
	"64":"ｋ",
	"65":"ｌ",
	"66":"ｍ",
	"67":"ｎ",
	"68":"ｏ",
	"69":"ｐ",
	"6A":"ｑ",
	"6B":"ｒ",
	"6C":"ｓ",
	"6D":"ｔ",
	"6E":"ｕ",
	"6F":"ｖ",
	"70":"ｗ",
	"71":"ｘ",
	"72":"ｙ",
	"73":"ｚ",
	"74":"ヴ",
	"75":"々",
	"76":"落",
	"77":"悪",
	"78":"入",
	"79":"手",
	"7A":"用",
	"7B":"先",
	"7C":"安",
	"7D":"誰",
	"7E":"音",
	"7F":"▽",
	"80":"主",
	"81":"人",
	"82":"町",
	"83":"森",
	"84":"来",
	"85":"間",
	"86":"思",
	"87":"合",
	"88":"光",
	"89":"消",
	"8A":"形",
	"8B":"回",
	"8C":"困",
	"8D":"長",
	"8E":"老",
	"8F":"東",
	"90":"西",
	"91":"歴",
	"92":"史",
	"93":"会",
	"94":"関",
	"95":"係",
	"96":"真",
	"97":"北",
	"98":"南",
	"99":"大",
	"9A":"地",
	"9B":"石",
	"9C":"目",
	"9D":"何",
	"9E":"林",
	"9F":"通",
	"A0":"男",
	"A1":"後",
	"A2":"店",
	"A3":"娘",
	"A4":"女",
	"A5":"供",
	"A6":"帝",
	"A7":"国",
	"A8":"私",
	"A9":"客",
	"AA":"化",
	"AB":"行",
	"AC":"方",
	"AD":"明",
	"AE":"皇",
	"AF":"要",
	"B0":"塞",
	"B1":"雨",
	"B2":"木",
	"B3":"滅",
	"B4":"君",
	"B5":"％",
	"B6":"生",
	"B7":"血",
	"B8":"佐",
	"B9":"守",
	"BA":"戦",
	"BB":"争",
	"BC":"騎",
	"BD":"士",
	"BE":"敵",
	"BF":"穴",
	"C0":"向",
	"C1":"引",
	"C2":"邪",
	"C3":"動",
	"C4":"成",
	"C5":"功",
	"C6":"夫",
	"C7":"文",
	"C8":"若",
	"C9":"流",
	"CA":"失",
	"CB":"水",
	"CC":"外",
	"CD":"自",
	"CE":"分",
	"CF":"身",
	"D0":"本",
	"D1":"弱",
	"D2":"失",
	"D3":"械",
	"D4":"賢",
	"D5":"者",
	"D6":"海",
	"D7":"島",
	"D8":"話",
	"D9":"界",
	"DA":"者",
	"DB":"死",
	"DC":"好",
	"DD":"災",
	"DE":"古",
	"DF":"代",
	"E0":"岩",
	"E1":"宝",
	"E2":"父",
	"E3":"年",
	"E4":"殿",
	"E5":"草",
	"E6":"高",
	"E7":"強",
	"E8":"切",
	"E9":"仲",
	"EA":"系",
	"EB":"白",
	"EC":"毒",
	"ED":"酸",
	"EE":"物",
	"EF":"復",
	"F0":"点",
	"F1":"眠",
	"F2":"宇",
	"F3":"宙",
	"F4":"陸",
	"F5":"少",
	"F6":"山",
	"F7":"指",
	"F8":"滝",
	"F9":"事",
	"FA":"当",
	"FB":"MP",
	"FC":"↑",
	"FD":"↓",
	"FE":"←",
	"FF":"→"
}
s2 = {v: k for k, v in s2.items()}

s3 = {
	"00":"主",
	"01":"人",
	"02":"町",
	"03":"森",
	"04":"来",
	"05":"間",
	"06":"思",
	"07":"合",
	"08":"光",
	"09":"消",
	"0A":"形",
	"0B":"回",
	"0C":"困",
	"0D":"長",
	"0E":"老",
	"0F":"東",
	"10":"西",
	"11":"歴",
	"12":"史",
	"13":"会",
	"14":"関",
	"15":"係",
	"16":"真",
	"17":"北",
	"18":"南",
	"19":"大",
	"1A":"地",
	"1B":"石",
	"1C":"目",
	"1D":"何",
	"1E":"林",
	"1F":"通",
	"20":"男",
	"21":"後",
	"22":"店",
	"23":"娘",
	"24":"女",
	"25":"供",
	"26":"帝",
	"27":"国",
	"28":"私",
	"29":"客",
	"2A":"化",
	"2B":"行",
	"2C":"方",
	"2D":"明",
	"2E":"皇",
	"2F":"要",
	"30":"塞",
	"31":"雨",
	"32":"木",
	"33":"滅",
	"34":"君",
	"35":"％",
	"36":"生",
	"37":"血",
	"38":"佐",
	"39":"守",
	"3A":"戦",
	"3B":"争",
	"3C":"騎",
	"3D":"士",
	"3E":"敵",
	"3F":"穴",
	"40":"向",
	"41":"引",
	"42":"邪",
	"43":"動",
	"44":"成",
	"45":"功",
	"46":"夫",
	"47":"文",
	"48":"若",
	"49":"流",
	"4A":"失",
	"4B":"水",
	"4C":"外",
	"4D":"自",
	"4E":"分",
	"4F":"身",
	"50":"本",
	"51":"弱",
	"52":"失",
	"53":"械",
	"54":"賢",
	"55":"者",
	"56":"海",
	"57":"島",
	"58":"話",
	"59":"界",
	"5A":"者",
	"5B":"死",
	"5C":"好",
	"5D":"災",
	"5E":"古",
	"5F":"代",
	"60":"岩",
	"61":"宝",
	"62":"父",
	"63":"年",
	"64":"殿",
	"65":"草",
	"66":"高",
	"67":"強",
	"68":"切",
	"69":"仲",
	"6A":"系",
	"6B":"白",
	"6C":"毒",
	"6D":"酸",
	"6E":"物",
	"6F":"復",
	"70":"点",
	"71":"眠",
	"72":"宇",
	"73":"宙",
	"74":"陸",
	"75":"少",
	"76":"山",
	"77":"指",
	"78":"滝",
	"79":"事",
	"7A":"当",
	"7B":"MP",
	"7C":"↑",
	"7D":"↓",
	"7E":"←",
	"7F":"→",
	"80":"押",
	"81":"以",
	"82":"城",
	"83":"字",
	"84":"十",
	"85":"決",
	"86":"選",
	"87":"定",
	"88":"時",
	"89":"左",
	"8A":"右",
	"8B":"進",
	"8C":"次",
	"8D":"戻",
	"8E":"魔",
	"8F":"見",
	"90":"法",
	"91":"力",
	"92":"人",
	"93":"器",
	"94":"避",
	"95":"武",
	"96":"変",
	"97":"各",
	"98":"攻",
	"99":"始",
	"9A":"撃",
	"9B":"消",
	"9C":"回",
	"9D":"終",
	"9E":"防",
	"9F":"御",
	"A0":"屋",
	"A1":"一",
	"A2":"現",
	"A3":"最",
	"A4":"初",
	"A5":"同",
	"A6":"上",
	"A7":"下",
	"A8":"技",
	"A9":"面",
	"AA":"共",
	"AB":"旅",
	"AC":"鳴",
	"AD":"平",
	"AE":"精",
	"AF":"和",
	"B0":"知",
	"B1":"体",
	"B2":"氷",
	"B3":"船",
	"B4":"中",
	"B5":"神",
	"B6":"命",
	"B7":"前",
	"B8":"小",
	"B9":"多",
	"BA":"世",
	"BB":"作",
	"BC":"続",
	"BD":"界",
	"BE":"獣",
	"BF":"金",
	"C0":"機",
	"C1":"接",
	"C2":"近",
	"C3":"待",
	"C4":"名",
	"C5":"勇",
	"C6":"気",
	"C7":"愛",
	"C8":"恵",
	"C9":"心",
	"CA":"砂",
	"CB":"漠",
	"CC":"底",
	"CD":"昔",
	"CE":"振",
	"CF":"起",
	"D0":"刀",
	"D1":"火",
	"D2":"炎",
	"D3":"竜",
	"D4":"天",
	"D5":"黄",
	"D6":"胸",
	"D7":"使",
	"D8":"闇",
	"D9":"道",
	"DA":"着",
	"DB":"革",
	"DC":"王",
	"DD":"冠",
	"DE":"霊",
	"DF":"羽",
	"E0":"母",
	"E1":"抜",
	"E2":"出",
	"E3":"村",
	"E4":"子",
	"E5":"砲",
	"E6":"爆",
	"E7":"弾",
	"E8":"針",
	"E9":"杯",
	"EA":"薬",
	"EB":"風",
	"EC":"太",
	"ED":"鼓",
	"EE":"種",
	"EF":"箱",
	"F0":"味",
	"F1":"裏",
	"F2":"丸",
	"F3":"月",
	"F4":"輪",
	"F5":"銀",
	"F6":"矢",
	"F7":"弓",
	"F8":"鉄",
	"F9":"能",
	"FA":"巨",
	"FB":"妖",
	"FC":"修",
	"FD":"封",
	"FE":"印",
	"FF":"聞"
}
s3 = {v: k for k, v in s3.items()}

def char2hex(s, tbl):
	out = ''
	for c in s:
		out += "<$%s>" % tbl[c]
	return out

def weight(s, tbl):
	weight = 0
	i = 0
	while i < len(s):
		c = s[i]
		if c in tbl:
			weight += 1
		else:
			return weight
		i += 1
	return weight
		
def jpn2hex(s):
	s = s 
	shex = []
	i = 0
	while i < len(s):
		c = s[i]
		# skip newlines
		if c == '\n':
			shex.append('\n')
			i += 1
			continue
		# skip commands
		if c == '[':
			close = s.find(']', i) + 1
			tag = s[i:close]
			shex.append(tag)
			i += len(tag)
			continue
		# skip hex bytes
		if c == '<':
			close = s.find('>', i) + 1
			tag = s[i:close]
			shex.append(tag)
			i += len(tag)
			continue
		# if current char in the d table, no need to search, just append it
		if c in d:
			shex.append("<$%s>" % d[c])
			i += 1
		else:
			ss = s[i:][:8] # up to 8 characters after current char

			s1w = weight(ss, s1)
			s2w = weight(ss, s2)
			s3w = weight(ss, s3)

			if s1w + s2w + s3w == 0:
				raise Exception("Character %s not in any table" % c)

			shift_byte = ""
			if s1w > s2w and s1w > s3w:
				# use s1
				if s1w > 8:# S1 codes can only affect up to the next 8 chars
					s1w = 8
				shift_byte = "<$%s>" % hex(96 + s1w - 1)[2:].zfill(2).upper() # $60-$67 for S1
				shex.append(shift_byte)
				shex.append(char2hex(s[i:i + s1w], s1))
				i += s1w
			elif s2w > s3w:
				# use s2
				if s2w > 4: # S2 codes can only affect up to the next 4 chars
					s2w = 4
				shift_byte = "<$%s>" % hex(104 + s2w - 1)[2:].zfill(2).upper() # $68-$6B for S2
				shex.append(shift_byte)
				shex.append(char2hex(s[i:i + s2w], s2))
				i += s2w
			else:
				# use s3
				if s3w > 4: # S3 codes can only affect up to the next 4 chars
					s3w = 4
				shift_byte = "<$%s>" % hex(108 + s3w - 1)[2:].zfill(2).upper() # $6C-$6F for S3
				shex.append(shift_byte)
				shex.append(char2hex(s[i:i + s3w], s3))
				i += s3w

	return ''.join(shex)

def convertlines(s):
	n = []

	for l in s.split('\n'):
		if l == '':
			n.append(l + '\n')
			continue
		if l[0:2] == "//":
			n.append(l + '\n')
			continue
		if l[0] == '#':
			n.append(l + '\n')
			continue
		n.append(jpn2hex(l) + '\n')

	out = ''.join(n)
	return out